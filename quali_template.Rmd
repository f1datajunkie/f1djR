---
title: "F1 Qualifying Template"
output:
  md_document:
    variant: gfm
params:
  stub: 'generic'
  outdir: 'quali'
  rootdir: './reports'
  year: 2018
  racenum: 1
  gp: "Australia"
  laptimeFilePath: "~/Dropbox/various/aus18_qualilaptimes.csv"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE,message=FALSE)

rootdir = params$rootdir
outdir = params$outdir
stub = params$stub
year = params$year
racenum = params$racenum
gp = params$gp

library(knitr)
options(knitr.kable.NA = '')
opts_knit$set(base.dir = paste(rootdir, outdir, sep='/'))
opts_chunk$set(fig.path = paste0("images/f1_",year,"_",stub,"-"))



laptimeFilePath = params$laptimeFilePath
```

```{r}
library(f1djR)

qlaps= read.csv(laptimeFilePath)
cutoff=c(15,10,2)
```

```{r}
##Session classifications page
#xx=pageGrabber('http://www.fia.com/events/fia-formula-one-world-championship/season-2017/session-classifications-19')
qr=qualiResults.df(year,racenum)

qr=quali_progression_ergast_tx(qr)
```

```{r}
#qr=quali_progression_ergast_tx(ergastifyQualiClass(fiaSessionClassQualifyingTidy(fiaTableGrabber(xx,4))))
qrm=quali_progression_ergast_melt(qr)
qrtmp=qr
for (i in c(1,2,3)) {
  qrtmp[[paste0('Q',i)]]=ifelse(is.na(qrtmp[[paste0('Q',i)]]),'',
                                paste0(qrtmp[[paste0('Q',i)]],' (',qrtmp[[paste0('q',i,'pos')]],')'))
}
```

```{r child = 'quali_template_child_progression.Rmd'}
```


The official session results were recorded as follows:
```{r}
qrtmp=rename(qrtmp, c("driverName"="DRIVER", "qspos"="POS"))
kable(subset(qrtmp,select=c('POS','DRIVER','Q1',	'Q2',	'Q3')), format='markdown',row.names = FALSE)
rm(qrtmp)
```

```{r}
qlapsb=rawLap_augment_quali(qlaps)
qlapsb=qsessionOverride(qlapsb,0,1200,2600)
qlapsb=quali_purplePatch(qlapsb)
```

```{r child = 'quali_template_child_session_utilisation.Rmd'}
```


```{r}
template=c("
## Q{{session}}",
"```{r quali{{session}}_gridplot}
c = ifelse({{session}}==3,2,10)
intercept= c(mean(qr[!is.na(qr['q{{session}}pos']) & (qr['q{{session}}pos']==c | qr['q{{session}}pos']==c+1),'q1time']))
promoter_ergastf1dj(gridPlotTime(qr,'q{{session}}time',pos='q{{session}}pos', session='Q{{session}}',intercepts = intercept))
```",
"
### `r ifelse({{session}}==3,'Front Row ','')`Cut-off Time Evolution

The cut-off time in Q{{session}} evolved as follows:",
"```{r quali{{session}}_cutoff}
promoter_ergastf1dj(quali_session_times_plots(qlapsb[qlapsb['qsession']=={{session}},],{{session}},FALSE,FALSE,TRUE,cutoff)+theme_bw())
```")
src = lapply(c(1,2,3), function(session) knit_expand(text=c(template)))

```
`r knit(text = unlist(src))`


---
 To learn how to wrangle F1 results and timing data to create charts like these, see [f1datajunkie.com](https://f1datajunkie.com) or [buy the *Wrangling F1 Data With R* book](https://leanpub.com/wranglingf1datawithr).
